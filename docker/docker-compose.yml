services:
  # ============================================
  # Real Hardware Services
  # ============================================
  shooter:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: shooter-ros-humble
    container_name: shooter-bringup
    privileged: true
    volumes:
      - /dev:/dev
      - ../epos:/ros2_ws/src/epos
      - ../shooter_description:/ros2_ws/src/shooter_description
      - ../shooter_bringup:/ros2_ws/src/shooter_bringup
      - ../shooter_control:/ros2_ws/src/shooter_control
    stdin_open: true
    tty: true
    command: bash

  shooter-run:
    image: shooter-ros-humble
    container_name: shooter-bringup-run
    privileged: true
    volumes:
      - /dev:/dev
    environment:
      - EPOS_USB_DEVICE=${EPOS_USB_DEVICE:-USB0}
    profiles:
      - real
    command: ros2 launch shooter_bringup shooter.launch.py enable_homing:=true

  keyboard:
    image: shooter-ros-humble
    container_name: shooter-teleop-keyboard
    stdin_open: true
    tty: true
    profiles:
      - keyboard
    command: >
      ros2 run teleop_twist_keyboard teleop_twist_keyboard
      --ros-args -r /cmd_vel:=/diff_drive_controller/cmd_vel_unstamped

  joystick:
    image: shooter-ros-humble
    container_name: shooter-teleop-joystick
    privileged: true
    volumes:
      - /dev/input:/dev/input
      - ./joystick.config.yaml:/config/joystick.config.yaml:ro
    environment:
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - ENABLE_TILT=${ENABLE_TILT:-false}
    profiles:
      - joystick
    command: >
      bash -c "ros2 launch teleop_twist_joy teleop-launch.py
      joy_vel:=/diff_drive_controller/cmd_vel_unstamped
      config_filepath:=/config/joystick.config.yaml
      device_id:=$${JOY_DEV_ID:-0} &
      ros2 run shooter_control pan_tilt_joy_node --ros-args
      -p pan_axis:=3
      -p tilt_axis:=4
      -p pan_scale:=0.005
      -p tilt_scale:=0.005
      -p enable_tilt:=$${ENABLE_TILT:-false}"

  body_tracker:
    image: shooter-ros-humble
    container_name: shooter-control
    privileged: true
    volumes:
      - /dev/video0:/dev/video0
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
    stdin_open: true
    tty: true
    profiles:
      - body
    command: ros2 launch shooter_control body_tracker.launch.py

  # ============================================
  # Simulation Services (Gazebo Sim)
  # ============================================
  sim:
    build:
      context: ..
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation
    volumes:
      - ../shooter_description:/ros2_ws/src/shooter_description
      - ../shooter_simulation:/ros2_ws/src/shooter_simulation
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: bash

  sim-run:
    build:
      context: ..
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation-run
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    profiles:
      - sim
    command: ros2 launch shooter_simulation sim.launch.py

networks:
  default:
    name: shooter
