services:
  # ============================================
  # Real Hardware Services
  # ============================================
  shooter:
    build: .
    image: shooter-ros-humble
    container_name: shooter
    privileged: true
    volumes:
      - /dev:/dev
      - ./epos:/ros2_ws/src/epos
      - ./shooter:/ros2_ws/src/shooter
    stdin_open: true
    tty: true
    command: bash

  shooter-run:
    image: shooter-ros-humble
    container_name: shooter-run
    privileged: true
    volumes:
      - /dev:/dev
    profiles:
      - face
      - keyboard
    command: ros2 launch shooter shooter.launch.py

  keyboard:
    image: shooter-ros-humble
    container_name: shooter-keyboard
    depends_on:
      - shooter-run
    stdin_open: true
    tty: true
    profiles:
      - keyboard
    command: ros2 run teleop_twist_keyboard teleop_twist_keyboard

  face_tracker:
    image: shooter-ros-humble
    container_name: shooter-face-tracker
    depends_on:
      - shooter-run
    privileged: true
    volumes:
      - /dev/video0:/dev/video0
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
    stdin_open: true
    tty: true
    profiles:
      - face
    command: ros2 launch shooter face_tracker.launch.py

  # ============================================
  # Simulation Services (Gazebo Sim)
  # ============================================
  sim:
    build:
      context: .
      dockerfile: Dockerfile.sim
    image: shooter-sim
    container_name: shooter-sim
    volumes:
      - ./shooter:/ros2_ws/src/shooter
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: bash

  sim-run:
    build:
      context: .
      dockerfile: Dockerfile.sim
    image: shooter-sim
    container_name: shooter-sim-run
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    profiles:
      - sim
      - sim-keyboard
    command: ros2 launch shooter sim.launch.py

  sim-keyboard:
    build:
      context: .
      dockerfile: Dockerfile.sim
    image: shooter-sim
    container_name: shooter-sim-keyboard
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: >
      ros2 run teleop_twist_keyboard teleop_twist_keyboard
      --ros-args -r /cmd_vel:=/diff_drive_controller/cmd_vel_unstamped

networks:
  default:
    name: shooter
