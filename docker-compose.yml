services:
  # ============================================
  # Real Hardware Services
  # ============================================
  shooter:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: shooter-ros-humble
    container_name: shooter-bringup
    privileged: true
    volumes:
      - /dev:/dev
      - ./epos:/ros2_ws/src/epos
      - ./shooter_description:/ros2_ws/src/shooter_description
      - ./shooter_bringup:/ros2_ws/src/shooter_bringup
      - ./shooter_control:/ros2_ws/src/shooter_control
    stdin_open: true
    tty: true
    command: bash

  shooter-run:
    image: shooter-ros-humble
    container_name: shooter-bringup-run
    privileged: true
    volumes:
      - /dev:/dev
    environment:
      - EPOS_USB_DEVICE=${EPOS_USB_DEVICE:-USB0}
      # Pan homing parameters
      - PAN_HOMING_ACCEL=4000
      - PAN_SPEED_SWITCH=4000
      - PAN_SPEED_INDEX=1500
      - PAN_CENTER_OFFSET=1650000
      - PAN_CENTER_VELOCITY=50000
      # Tilt homing parameters
      - TILT_HOMING_ACCEL=500
      - TILT_SPEED_SWITCH=250
      - TILT_SPEED_INDEX=100
      - TILT_CENTER_OFFSET=110000
      - TILT_CENTER_VELOCITY=3000
      - HOMING_TIMEOUT=60000
    profiles:
      - real
    command: ros2 launch shooter_bringup shooter.launch.py enable_homing:=true

  keyboard:
    image: shooter-ros-humble
    container_name: shooter-teleop-keyboard
    stdin_open: true
    tty: true
    profiles:
      - keyboard
    command: >
      ros2 run teleop_twist_keyboard teleop_twist_keyboard
      --ros-args -r /cmd_vel:=/diff_drive_controller/cmd_vel_unstamped

  joystick:
    image: shooter-ros-humble
    container_name: shooter-teleop-joystick
    privileged: true
    volumes:
      - /dev/input:/dev/input
      - /sys/class/pwm:/sys/class/pwm
      - ./docker/joystick.config.yaml:/config/joystick.config.yaml:ro
    environment:
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - PWM_CHIP=${PWM_CHIP:-0}
      - PWM_CHANNEL=${PWM_CHANNEL:-0}
      - SERVO_IDLE_DEG=${SERVO_IDLE_DEG:-0.0}
      - SERVO_TRIGGER_DEG=${SERVO_TRIGGER_DEG:-180.0}
    profiles:
      - joystick
    command: >
      bash -c "ros2 launch teleop_twist_joy teleop-launch.py
      joy_vel:=/diff_drive_controller/cmd_vel_unstamped
      config_filepath:=/config/joystick.config.yaml
      device_id:=$${JOY_DEV_ID:-0} &
      ros2 run shooter_control pan_tilt_joy_node --ros-args
      -p pan_axis:=3
      -p tilt_axis:=4
      -p pan_velocity:=2000.0
      -p tilt_velocity:=-300.0
      -p shooter_speed_rpm:=-10000.0 &
      (ros2 run shooter_control servo_trigger_node --ros-args
      -p pwm_chip:=$${PWM_CHIP:-0}
      -p pwm_channel:=$${PWM_CHANNEL:-0}
      -p trigger_button:=5
      -p return_delay_ms:=500
      -p idle_angle_deg:=$${SERVO_IDLE_DEG:-0.0}
      -p trigger_angle_deg:=$${SERVO_TRIGGER_DEG:-180.0} || echo 'servo_trigger_node failed, continuing without it') &
      wait"

  body_tracker:
    image: shooter-ros-humble
    container_name: shooter-body-tracker
    privileged: true
    volumes:
      - /dev/video0:/dev/video0
      - /dev/input:/dev/input
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - CAMERA_DEVICE_ID=${CAMERA_DEVICE_ID:-0}
      - TRACKING_BUTTON=${TRACKING_BUTTON:-0}
    stdin_open: true
    tty: true
    profiles:
      - body
    command: >
      bash -c "ros2 run joy joy_node --ros-args -p device_id:=$${JOY_DEV_ID:-0} &
      ros2 launch shooter_control body_tracker.launch.py
      camera_device_id:=$${CAMERA_DEVICE_ID:-0}
      tracking_button_index:=$${TRACKING_BUTTON:-0}"

  # ============================================
  # Simulation Services (Gazebo Sim)
  # ============================================
  sim:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation
    volumes:
      - ./shooter_description:/ros2_ws/src/shooter_description
      - ./shooter_simulation:/ros2_ws/src/shooter_simulation
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: bash

  sim-run:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation-run
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    profiles:
      - sim
    command: ros2 launch shooter_simulation sim.launch.py

networks:
  default:
    name: shooter
