services:
  # ============================================
  # Real Hardware Services
  # ============================================
  chikurin:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: chikurin-ros-humble
    container_name: chikurin-bringup
    privileged: true
    volumes:
      - /dev:/dev
      - ./epos:/ros2_ws/src/epos
      - ./chikurin_description:/ros2_ws/src/chikurin_description
      - ./chikurin_control:/ros2_ws/src/chikurin_control
    stdin_open: true
    tty: true
    command: bash

  chikurin-run:
    image: chikurin-ros-humble
    container_name: chikurin-bringup-run
    privileged: true
    volumes:
      - /dev:/dev
    environment:
      - EPOS_USB_DEVICE=${EPOS_USB_DEVICE:-USB0}
    profiles:
      - joystick
      - joystick_udp
      - keyboard
    command: ros2 launch chikurin_description robot.launch.py enable_homing:=true

  keyboard:
    image: chikurin-ros-humble
    container_name: chikurin-teleop-keyboard
    stdin_open: true
    tty: true
    profiles:
      - keyboard
    command: >
      ros2 run teleop_twist_keyboard teleop_twist_keyboard
      --ros-args -r /cmd_vel:=/diff_drive_controller/cmd_vel_unstamped

  joystick:
    image: chikurin-ros-humble
    container_name: chikurin-teleop-joystick
    privileged: true
    volumes:
      - /dev/input:/dev/input
      - /sys/class/pwm:/sys/class/pwm
      - ./docker/joystick.config.yaml:/config/joystick.config.yaml:ro
    environment:
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - PWM_CHIP=${PWM_CHIP:-0}
      - PWM_CHANNEL=${PWM_CHANNEL:-0}
      - SERVO_IDLE_DEG=${SERVO_IDLE_DEG:-0.0}
      - SERVO_TRIGGER_DEG=${SERVO_TRIGGER_DEG:-180.0}
    profiles:
      - joystick
    command: >
      bash -c "ros2 launch teleop_twist_joy teleop-launch.py
      joy_vel:=/diff_drive_controller/cmd_vel_unstamped
      config_filepath:=/config/joystick.config.yaml
      device_id:=$${JOY_DEV_ID:-0} &
      ros2 run chikurin_control pan_tilt_joy_node --ros-args
      -p pan_axis:=3
      -p tilt_axis:=4
      -p pan_velocity:=2000.0
      -p tilt_velocity:=-300.0
      -p shooter_speed_rpm:=-10000.0 &
      (ros2 run chikurin_control servo_trigger_node --ros-args
      -p pwm_chip:=$${PWM_CHIP:-0}
      -p pwm_channel:=$${PWM_CHANNEL:-0}
      -p trigger_button:=5
      -p return_delay_ms:=500
      -p idle_angle_deg:=$${SERVO_IDLE_DEG:-0.0}
      -p trigger_angle_deg:=$${SERVO_TRIGGER_DEG:-180.0} || echo 'servo_trigger_node failed, continuing without it') &
      wait"

  joystick_udp:
    image: chikurin-ros-humble
    container_name: chikurin-teleop-joystick-udp
    privileged: true
    network_mode: host
    volumes:
      - /sys/class/pwm:/sys/class/pwm
      - ./docker/joystick.config.yaml:/config/joystick.config.yaml:ro
    environment:
      - UDP_HOST=${UDP_HOST:-0.0.0.0}
      - UDP_PORT=${UDP_PORT:-5005}
      - PWM_CHIP=${PWM_CHIP:-0}
      - PWM_CHANNEL=${PWM_CHANNEL:-0}
      - SERVO_IDLE_DEG=${SERVO_IDLE_DEG:-0.0}
      - SERVO_TRIGGER_DEG=${SERVO_TRIGGER_DEG:-180.0}
    profiles:
      - joystick_udp
    command: >
      bash -c "ros2 run teleop_udp udp_receiver_node --ros-args
      -p host:=$${UDP_HOST:-0.0.0.0}
      -p port:=$${UDP_PORT:-5005} &
      ros2 launch teleop_twist_joy teleop-launch.py
      joy_vel:=/diff_drive_controller/cmd_vel_unstamped
      config_filepath:=/config/joystick.config.yaml &
      ros2 run chikurin_control pan_tilt_joy_node --ros-args
      -p pan_axis:=3
      -p tilt_axis:=4
      -p pan_velocity:=2000.0
      -p tilt_velocity:=-300.0
      -p shooter_speed_rpm:=-10000.0 &
      (ros2 run chikurin_control servo_trigger_node --ros-args
      -p pwm_chip:=$${PWM_CHIP:-0}
      -p pwm_channel:=$${PWM_CHANNEL:-0}
      -p trigger_button:=5
      -p return_delay_ms:=500
      -p idle_angle_deg:=$${SERVO_IDLE_DEG:-0.0}
      -p trigger_angle_deg:=$${SERVO_TRIGGER_DEG:-180.0} || echo 'servo_trigger_node failed, continuing without it') &
      wait"

  body_tracker:
    image: chikurin-ros-humble
    container_name: chikurin-body-tracker
    privileged: true
    volumes:
      - /dev:/dev
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /sys/class/pwm:/sys/class/pwm
    environment:
      - DISPLAY=${DISPLAY}
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - CAMERA_DEVICE_ID=${CAMERA_DEVICE_ID:-0}
      - TRACKING_BUTTON=${TRACKING_BUTTON:-0}
      - SHOW_WINDOW=${SHOW_WINDOW:-true}
      - PWM_CHIP=${PWM_CHIP:-0}
      - PWM_CHANNEL=${PWM_CHANNEL:-0}
      - SERVO_IDLE_DEG=${SERVO_IDLE_DEG:-0.0}
      - SERVO_TRIGGER_DEG=${SERVO_TRIGGER_DEG:-180.0}
      - PAN_KP=${PAN_KP:-0.002}
      - PAN_KI=${PAN_KI:-0.0001}
      - TILT_KP=${TILT_KP:-0.002}
      - TILT_KI=${TILT_KI:-0.0001}
      - BASE_ANGULAR_GAIN=${BASE_ANGULAR_GAIN:-0.5}
      - VELOCITY_FEEDFORWARD_GAIN=${VELOCITY_FEEDFORWARD_GAIN:-0.005}
      - VERIFICATION_INTERVAL=${VERIFICATION_INTERVAL:-30}
      - DETECTION_MISS_THRESHOLD=${DETECTION_MISS_THRESHOLD:-3}
      - DETECTION_SKIP_FRAMES=${DETECTION_SKIP_FRAMES:-3}
      # Scan parameters (encoder count based, with 90% safety margin)
      # PAN: limit ±1650000 counts → 90% = ±1485000 counts
      # TILT: limit based on mechanical range
      - SCAN_ENABLED=${SCAN_ENABLED:-true}
      - SCAN_PAN_VELOCITY=${SCAN_PAN_VELOCITY:-0.5}
      - SCAN_TILT_VELOCITY=${SCAN_TILT_VELOCITY:-0.3}
      - PAN_COUNTS_PER_REVOLUTION=${PAN_COUNTS_PER_REVOLUTION:-6600000.0}
      - TILT_COUNTS_PER_REVOLUTION=${TILT_COUNTS_PER_REVOLUTION:-6600000.0}
      - SCAN_PAN_MIN_COUNTS=${SCAN_PAN_MIN_COUNTS:--1485000}
      - SCAN_PAN_MAX_COUNTS=${SCAN_PAN_MAX_COUNTS:-1485000}
      - SCAN_TILT_MIN_COUNTS=${SCAN_TILT_MIN_COUNTS:--450000}
      - SCAN_TILT_MAX_COUNTS=${SCAN_TILT_MAX_COUNTS:-270000}
      - SCAN_TILT_STEP_COUNTS=${SCAN_TILT_STEP_COUNTS:-180000}
      # Auto-fire parameters
      - AUTO_FIRE_ENABLED=${AUTO_FIRE_ENABLED:-false}
      - AUTO_FIRE_THRESHOLD=${AUTO_FIRE_THRESHOLD:-0.7}
      - AUTO_FIRE_COOLDOWN_MS=${AUTO_FIRE_COOLDOWN_MS:-2000}
      - AUTO_FIRE_CENTER_TOLERANCE=${AUTO_FIRE_CENTER_TOLERANCE:-0.15}
      - SHOOTER_SPEED_RPM=${SHOOTER_SPEED_RPM:-10000.0}
      - SHOOTER_SPINUP_MS=${SHOOTER_SPINUP_MS:-500}
      - SHOOTER_FIRE_DURATION_MS=${SHOOTER_FIRE_DURATION_MS:-300}
    stdin_open: true
    tty: true
    profiles:
      - body
    command: >
      bash -c "(ros2 run chikurin_control servo_trigger_node --ros-args
      -p pwm_chip:=$${PWM_CHIP:-0}
      -p pwm_channel:=$${PWM_CHANNEL:-0}
      -p trigger_button:=5
      -p return_delay_ms:=500
      -p idle_angle_deg:=$${SERVO_IDLE_DEG:-0.0}
      -p trigger_angle_deg:=$${SERVO_TRIGGER_DEG:-180.0} || echo 'servo_trigger_node failed') &
      ros2 run joy joy_node --ros-args -p device_id:=$${JOY_DEV_ID:-0} &
      sleep 2 &&
      ros2 launch chikurin_control body_tracker.launch.py
      camera_device_id:=$${CAMERA_DEVICE_ID:-0}
      tracking_button_index:=$${TRACKING_BUTTON:-0}
      show_window:=$${SHOW_WINDOW:-false}
      pan_kp:=$${PAN_KP:-0.002}
      pan_ki:=$${PAN_KI:-0.0001}
      tilt_kp:=$${TILT_KP:-0.002}
      tilt_ki:=$${TILT_KI:-0.0001}
      base_angular_gain:=$${BASE_ANGULAR_GAIN:-0.5}
      velocity_feedforward_gain:=$${VELOCITY_FEEDFORWARD_GAIN:-0.005}
      verification_interval:=$${VERIFICATION_INTERVAL:-30}
      detection_miss_threshold:=$${DETECTION_MISS_THRESHOLD:-3}
      detection_skip_frames:=$${DETECTION_SKIP_FRAMES:-3}
      scan_enabled:=$${SCAN_ENABLED:-true}
      scan_pan_velocity:=$${SCAN_PAN_VELOCITY:-0.5}
      scan_tilt_velocity:=$${SCAN_TILT_VELOCITY:-0.3}
      pan_counts_per_revolution:=$${PAN_COUNTS_PER_REVOLUTION:-6600000.0}
      tilt_counts_per_revolution:=$${TILT_COUNTS_PER_REVOLUTION:-6600000.0}
      scan_pan_min_counts:=$${SCAN_PAN_MIN_COUNTS:--1485000}
      scan_pan_max_counts:=$${SCAN_PAN_MAX_COUNTS:-1485000}
      scan_tilt_min_counts:=$${SCAN_TILT_MIN_COUNTS:--450000}
      scan_tilt_max_counts:=$${SCAN_TILT_MAX_COUNTS:-270000}
      scan_tilt_step_counts:=$${SCAN_TILT_STEP_COUNTS:-180000}
      auto_fire_enabled:=$${AUTO_FIRE_ENABLED:-false}
      auto_fire_threshold:=$${AUTO_FIRE_THRESHOLD:-0.7}
      auto_fire_cooldown_ms:=$${AUTO_FIRE_COOLDOWN_MS:-2000}
      auto_fire_center_tolerance:=$${AUTO_FIRE_CENTER_TOLERANCE:-0.15}
      shooter_speed_rpm:=$${SHOOTER_SPEED_RPM:-10000.0}
      shooter_spinup_ms:=$${SHOOTER_SPINUP_MS:-500}
      shooter_fire_duration_ms:=$${SHOOTER_FIRE_DURATION_MS:-300}"

  # ============================================
  # Simulation Services (Gazebo Sim)
  # ============================================
  sim:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: chikurin-sim
    container_name: chikurin-simulation
    volumes:
      - ./chikurin_description:/ros2_ws/src/chikurin_description
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: bash

  sim-run:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: chikurin-sim
    container_name: chikurin-simulation-run
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    profiles:
      - sim
    command: ros2 launch chikurin_description sim.launch.py

networks:
  default:
    name: chikurin
