services:
  # ============================================
  # Real Hardware Services
  # ============================================
  shooter:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: shooter-ros-humble
    container_name: shooter-bringup
    privileged: true
    volumes:
      - /dev:/dev
      - ./epos:/ros2_ws/src/epos
      - ./shooter_description:/ros2_ws/src/shooter_description
      - ./shooter_bringup:/ros2_ws/src/shooter_bringup
      - ./shooter_control:/ros2_ws/src/shooter_control
    stdin_open: true
    tty: true
    command: bash

  shooter-run:
    image: shooter-ros-humble
    container_name: shooter-bringup-run
    privileged: true
    volumes:
      - /dev:/dev
    environment:
      - EPOS_USB_DEVICE=${EPOS_USB_DEVICE:-USB0}
      # Pan homing parameters
      - PAN_HOMING_ACCEL=4000
      - PAN_SPEED_SWITCH=4000
      - PAN_SPEED_INDEX=1500
      - PAN_CENTER_OFFSET=1650000
      - PAN_CENTER_VELOCITY=50000
      # Tilt homing parameters
      - TILT_HOMING_ACCEL=500
      - TILT_SPEED_SWITCH=250
      - TILT_SPEED_INDEX=100
      - TILT_CENTER_OFFSET=110000
      - TILT_CENTER_VELOCITY=3000
      - HOMING_TIMEOUT=60000
    profiles:
      - real
    command: ros2 launch shooter_bringup shooter.launch.py enable_homing:=true

  keyboard:
    image: shooter-ros-humble
    container_name: shooter-teleop-keyboard
    stdin_open: true
    tty: true
    profiles:
      - keyboard
    command: >
      ros2 run teleop_twist_keyboard teleop_twist_keyboard
      --ros-args -r /cmd_vel:=/diff_drive_controller/cmd_vel_unstamped

  joystick:
    image: shooter-ros-humble
    container_name: shooter-teleop-joystick
    privileged: true
    volumes:
      - /dev/input:/dev/input
      - /sys/class/pwm:/sys/class/pwm
      - ./docker/joystick.config.yaml:/config/joystick.config.yaml:ro
    environment:
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - PWM_CHIP=${PWM_CHIP:-0}
      - PWM_CHANNEL=${PWM_CHANNEL:-0}
      - SERVO_IDLE_DEG=${SERVO_IDLE_DEG:-0.0}
      - SERVO_TRIGGER_DEG=${SERVO_TRIGGER_DEG:-180.0}
    profiles:
      - joystick
    command: >
      bash -c "ros2 launch teleop_twist_joy teleop-launch.py
      joy_vel:=/diff_drive_controller/cmd_vel_unstamped
      config_filepath:=/config/joystick.config.yaml
      device_id:=$${JOY_DEV_ID:-0} &
      ros2 run shooter_control pan_tilt_joy_node --ros-args
      -p pan_axis:=3
      -p tilt_axis:=4
      -p pan_velocity:=2000.0
      -p tilt_velocity:=-300.0
      -p shooter_speed_rpm:=-10000.0 &
      (ros2 run shooter_control servo_trigger_node --ros-args
      -p pwm_chip:=$${PWM_CHIP:-0}
      -p pwm_channel:=$${PWM_CHANNEL:-0}
      -p trigger_button:=5
      -p return_delay_ms:=500
      -p idle_angle_deg:=$${SERVO_IDLE_DEG:-0.0}
      -p trigger_angle_deg:=$${SERVO_TRIGGER_DEG:-180.0} || echo 'servo_trigger_node failed, continuing without it') &
      wait"

  body_tracker:
    image: shooter-ros-humble
    container_name: shooter-body-tracker
    privileged: true
    volumes:
      - /dev:/dev
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - JOY_DEV_ID=${JOY_DEV_ID:-0}
      - CAMERA_DEVICE_ID=${CAMERA_DEVICE_ID:-0}
      - TRACKING_BUTTON=${TRACKING_BUTTON:-0}
      - SHOW_WINDOW=${SHOW_WINDOW:-true}
      - PAN_KP=${PAN_KP:-0.002}
      - PAN_KI=${PAN_KI:-0.0001}
      - TILT_KP=${TILT_KP:-0.002}
      - TILT_KI=${TILT_KI:-0.0001}
      - BASE_ANGULAR_GAIN=${BASE_ANGULAR_GAIN:-0.5}
      - VELOCITY_FEEDFORWARD_GAIN=${VELOCITY_FEEDFORWARD_GAIN:-0.005}
      - VERIFICATION_INTERVAL=${VERIFICATION_INTERVAL:-30}
      - DETECTION_MISS_THRESHOLD=${DETECTION_MISS_THRESHOLD:-3}
      - DETECTION_SKIP_FRAMES=${DETECTION_SKIP_FRAMES:-3}
      # Scan parameters (set based on homing center offset)
      # PAN: CENTER_OFFSET=1650000 counts → ±1.5 rad typical range
      # TILT: CENTER_OFFSET=110000 counts → -0.5 to +0.3 rad typical range
      - SCAN_ENABLED=${SCAN_ENABLED:-true}
      - SCAN_PAN_VELOCITY=${SCAN_PAN_VELOCITY:-0.5}
      - SCAN_TILT_VELOCITY=${SCAN_TILT_VELOCITY:-0.3}
      - SCAN_PAN_MIN=${SCAN_PAN_MIN:--1.5}
      - SCAN_PAN_MAX=${SCAN_PAN_MAX:-1.5}
      - SCAN_TILT_MIN=${SCAN_TILT_MIN:--0.5}
      - SCAN_TILT_MAX=${SCAN_TILT_MAX:-0.3}
      - SCAN_TILT_STEP=${SCAN_TILT_STEP:-0.3}
      # Auto-fire parameters
      - AUTO_FIRE_ENABLED=${AUTO_FIRE_ENABLED:-false}
      - AUTO_FIRE_THRESHOLD=${AUTO_FIRE_THRESHOLD:-0.7}
      - AUTO_FIRE_COOLDOWN_MS=${AUTO_FIRE_COOLDOWN_MS:-2000}
      - AUTO_FIRE_CENTER_TOLERANCE=${AUTO_FIRE_CENTER_TOLERANCE:-0.15}
      - SHOOTER_SPEED_RPM=${SHOOTER_SPEED_RPM:-10000.0}
      - SHOOTER_SPINUP_MS=${SHOOTER_SPINUP_MS:-500}
      - SHOOTER_FIRE_DURATION_MS=${SHOOTER_FIRE_DURATION_MS:-300}
    stdin_open: true
    tty: true
    profiles:
      - body
    command: >
      bash -c "ros2 run joy joy_node --ros-args -p device_id:=$${JOY_DEV_ID:-0} &
      ros2 launch shooter_control body_tracker.launch.py
      camera_device_id:=$${CAMERA_DEVICE_ID:-0}
      tracking_button_index:=$${TRACKING_BUTTON:-0}
      show_window:=$${SHOW_WINDOW:-false}
      pan_kp:=$${PAN_KP:-0.002}
      pan_ki:=$${PAN_KI:-0.0001}
      tilt_kp:=$${TILT_KP:-0.002}
      tilt_ki:=$${TILT_KI:-0.0001}
      base_angular_gain:=$${BASE_ANGULAR_GAIN:-0.5}
      velocity_feedforward_gain:=$${VELOCITY_FEEDFORWARD_GAIN:-0.005}
      verification_interval:=$${VERIFICATION_INTERVAL:-30}
      detection_miss_threshold:=$${DETECTION_MISS_THRESHOLD:-3}
      detection_skip_frames:=$${DETECTION_SKIP_FRAMES:-3}
      scan_enabled:=$${SCAN_ENABLED:-true}
      scan_pan_velocity:=$${SCAN_PAN_VELOCITY:-0.5}
      scan_tilt_velocity:=$${SCAN_TILT_VELOCITY:-0.3}
      scan_pan_min:=$${SCAN_PAN_MIN:--1.5}
      scan_pan_max:=$${SCAN_PAN_MAX:-1.5}
      scan_tilt_min:=$${SCAN_TILT_MIN:--0.5}
      scan_tilt_max:=$${SCAN_TILT_MAX:-0.3}
      scan_tilt_step:=$${SCAN_TILT_STEP:-0.3}
      auto_fire_enabled:=$${AUTO_FIRE_ENABLED:-false}
      auto_fire_threshold:=$${AUTO_FIRE_THRESHOLD:-0.7}
      auto_fire_cooldown_ms:=$${AUTO_FIRE_COOLDOWN_MS:-2000}
      auto_fire_center_tolerance:=$${AUTO_FIRE_CENTER_TOLERANCE:-0.15}
      shooter_speed_rpm:=$${SHOOTER_SPEED_RPM:-10000.0}
      shooter_spinup_ms:=$${SHOOTER_SPINUP_MS:-500}
      shooter_fire_duration_ms:=$${SHOOTER_FIRE_DURATION_MS:-300}"

  # ============================================
  # Simulation Services (Gazebo Sim)
  # ============================================
  sim:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation
    volumes:
      - ./shooter_description:/ros2_ws/src/shooter_description
      - ./shooter_simulation:/ros2_ws/src/shooter_simulation
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    stdin_open: true
    tty: true
    profiles:
      - sim
    command: bash

  sim-run:
    build:
      context: .
      dockerfile: docker/Dockerfile.sim
    image: shooter-sim
    container_name: shooter-simulation-run
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    profiles:
      - sim
    command: ros2 launch shooter_simulation sim.launch.py

networks:
  default:
    name: shooter
